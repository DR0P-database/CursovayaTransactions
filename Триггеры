-- Триггеры
-- Таблица для логгирования
CREATE TABLE conflict_log (
    id            bigserial PRIMARY KEY,
    logged_at     timestamptz DEFAULT now() NOT NULL,
    operation     text NOT NULL,              -- INSERT / UPDATE / DELETE
    table_name    text NOT NULL,              -- bank_account / doctors
    conflict_type text NOT NULL DEFAULT 'SUCCESS',  -- SUCCESS / LOST_UPDATE / WRITE_SKEW и т.д.
    old_balance   numeric(8,2),              -- NULL при INSERT
    new_balance   numeric(8,2),              -- NULL при DELETE
    old_on_duty   boolean,                    -- NULL для bank_account
    new_on_duty   boolean,                    -- NULL для bank_account
    message       text                        -- кастомное сообщение
);

-- Триггер для updtate lost
CREATE TRIGGER trg_prevent_lost_update
	BEFORE UPDATE ON bank_accounts
	FOR EACH ROW
	EXECUTE FUNCTION prevent_lost_update();

-- Триггер для Non-repeatable Read и Phantom Read
CREATE OR REPLACE TRIGGER guarded_write_trigger
    BEFORE INSERT OR UPDATE OR DELETE
    ON bank_accounts
    FOR EACH ROW
    EXECUTE FUNCTION guarded_write();


-- Тригер для предотвращения Anomaly / Write Skew
CREATE OR REPLACE TRIGGER trg_lock_doctors_active_status
    BEFORE UPDATE OF status ON doctors
    FOR EACH ROW
    WHEN (OLD.status = true AND NEW.status = false)
    EXECUTE FUNCTION trg_lock_doctors_active_status();
