-- UPDATE LOCK окно №1
BEGIN;
-- Читаем счёт — автоматически сохраняется xmin!
SELECT * FROM get_account(1);

--выполенение транзакции №2

--Птаемся обновить
UPDATE bank_accounts SET balance = 30000 WHERE id = 1;
-- → если строка не изменилась → проходит
-- → если изменилась → триггер ловит, пишет в conflict_log и не обновляет данные
COMMIT;

-- UPDATE LOCK окно №2
BEGIN;
SELECT * FROM get_account(1);
UPDATE bank_accounts SET balance = 2000 WHERE id = 1;
COMMIT;


-- Non-repeatable Read окно №1
BEGIN;
SELECT * FROM guarded_query('SELECT sum(balance) FROM bank_accounts')
-- Выпполняется тразакнция №2

-- COMMIT 1 транзакции
SELECT * FROM guarded_query('SELECT sum(balance) FROM bank_accounts')  -- уже 83800!
COMMIT;


-- Phantom Read окно №1
BEGIN;
SELECT * FROM guarded_query ('SELECT count(*) FROM bank_accounts WHERE balance < 16000') -- результат : 2
-- Выпполняется тразакнция №2

-- COMMIT 1 транзакции
SELECT * FROM guarded_query ('SELECT count(*) FROM bank_accounts WHERE balance < 16000')  -- уже 3!
COMMIT;


-- Anomaly / Write Skew окно №1
BEGIN;
SELECT id, full_name, status FROM doctors WHERE status = true;
-- Транзакция №2 выполняется

-- COMMIT транзакции №1
UPDATE doctors SET status = false WHERE id = 1;
COMMIT;   -- ← Иванов тоже ушёл
