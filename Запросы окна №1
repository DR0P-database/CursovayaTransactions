-- UPDATE LOCK окно №1
BEGIN;
-- Читаем счёт — автоматически сохраняется xmin!
SELECT * FROM get_account(1);

--выполенение транзакции №2

--Птаемся обновить
UPDATE bank_accounts SET balance = 30000 WHERE id = 1;
-- → если строка не изменилась → проходит
-- → если изменилась → триггер ловит, пишет в conflict_log и не обновляет данные
COMMIT;

-- Non-repeatable Read окно №1
BEGIN;
-- Читаем данные в первый раз
SELECT sum(balance) FROM guarded_query_accounts('true')
-- Выпполняется тразакнция №2

-- Читаем данные ещё раз и получаем такой же результат
SELECT sum(balance) FROM bank_accounts
COMMIT;


-- Phantom Read окно №1
BEGIN;
-- Читаем данные в первый ра
SELECT count(*) FROM guarded_query_accounts('true')

-- Выпполняется тразакнция №2

-- Читаем данные ещё раз и получаем такой же результат
SELECT count(*) FROM bank_accounts
COMMIT;


-- Anomaly / Write Skew окно №1
BEGIN;
-- Смотрим сколько у нас активных врачей
SELECT * FROM bank_accounts WHERE is_active = true

-- Пытаемся снять себя с работы
UPDATE bank_accounts SET is_active = false WHERE id=2
COMMIT;
